<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MACP æ§åˆ¶å°</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e17; --bg2: #111827; --bg3: #1a2234; --card: #151d2e;
      --border: #2a3548; --text: #f1f5f9; --text2: #94a3b8; --muted: #64748b;
      --accent: #3b82f6; --accent2: #2563eb; --success: #10b981; --warning: #f59e0b; --error: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    
    .layout { display: flex; min-height: 100vh; }
    
    .sidebar { width: 240px; background: var(--bg2); border-right: 1px solid var(--border); padding: 20px; position: fixed; height: 100vh; }
    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
    .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .logo-text { font-size: 18px; font-weight: 600; }
    
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 8px; color: var(--text2); cursor: pointer; margin-bottom: 4px; transition: 0.2s; }
    .nav-item a { color: inherit; text-decoration: none; display: flex; align-items: center; gap: 10px; width: 100%; }
    .nav-item:hover { background: var(--bg3); color: var(--text); }
    .nav-item.active { background: rgba(59,130,246,0.15); color: var(--accent); }
    
    .main { flex: 1; margin-left: 240px; }
    .header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 16px 30px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; }
    .btn { padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; }
    .btn-secondary { background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
    
    .content { padding: 24px 30px; }
    
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
    .stat::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), #8b5cf6); }
    .stat:nth-child(2)::before { background: linear-gradient(90deg, var(--success), #06b6d4); }
    .stat:nth-child(3)::before { background: linear-gradient(90deg, var(--warning), var(--error)); }
    .stat:nth-child(4)::before { background: linear-gradient(90deg, #8b5cf6, var(--accent)); }
    .stat-label { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    .stat-value { font-size: 28px; font-weight: 700; }
    
    .section { margin-bottom: 28px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .section-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    
    .agents { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
    .agent { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: 0.3s; cursor: pointer; }
    .agent:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .agent-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .agent-btn { flex: 1; padding: 8px 12px; border-radius: 6px; font-size: 12px; border: none; cursor: pointer; transition: 0.2s; }
    .agent-btn.start { background: rgba(16,185,129,0.15); color: var(--success); }
    .agent-btn.start:hover { background: var(--success); color: white; }
    .agent-btn.stop { background: rgba(239,68,68,0.15); color: var(--error); }
    .agent-btn.stop:hover { background: var(--error); color: white; }
    .agent-btn.config { background: rgba(59,130,246,0.15); color: var(--accent); }
    .agent-btn.config:hover { background: var(--accent); color: white; }
    .agent-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .agent-avatar { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .agent-avatar.idle { background: rgba(16,185,129,0.15); color: var(--success); }
    .agent-avatar.busy { background: rgba(245,158,11,0.15); color: var(--warning); }
    .agent-avatar.error { background: rgba(239,68,68,0.15); color: var(--error); }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
    .status-badge.idle { background: rgba(16,185,129,0.15); color: var(--success); }
    .status-badge.busy { background: rgba(245,158,11,0.15); color: var(--warning); }
    .agent-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .agent-domain { font-size: 12px; color: var(--muted); margin-bottom: 10px; }
    .agent-desc { font-size: 13px; color: var(--text2); line-height: 1.5; margin-bottom: 12px; }
    .caps { display: flex; flex-wrap: wrap; gap: 6px; }
    .cap { background: var(--bg3); padding: 4px 10px; border-radius: 6px; font-size: 11px; color: var(--text2); border: 1px solid var(--border); }
    
    .tasks { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .task { display: flex; align-items: center; padding: 14px 18px; border-bottom: 1px solid var(--border); }
    .task:last-child { border-bottom: none; }
    .task:hover { background: var(--bg3); }
    .task-info { flex: 1; }
    .task-name { font-size: 14px; font-weight: 500; margin-bottom: 3px; }
    .task-meta { font-size: 12px; color: var(--muted); }
    .task-status { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 500; }
    .task-status.pending { background: var(--bg3); color: var(--text2); }
    .task-status.running { background: rgba(245,158,11,0.15); color: var(--warning); }
    .task-status.completed { background: rgba(16,185,129,0.15); color: var(--success); }
    .task-status.failed { background: rgba(239,68,68,0.15); color: var(--error); }
    
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px; }
    .modal.show { display: flex; }
    .modal-content { background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    .modal-large { max-width: 800px; }
    .modal-header { padding: 18px 22px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 22px; }
    .agent-detail-header { display: flex; gap: 20px; margin-bottom: 20px; }
    .agent-detail-avatar { width: 80px; height: 80px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; }
    .agent-detail-info { flex: 1; }
    .agent-detail-name { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
    .agent-detail-domain { font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    .agent-detail-desc { font-size: 14px; color: var(--text2); line-height: 1.5; }
    .agent-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
    .agent-stat { background: var(--bg3); padding: 14px; border-radius: 8px; text-align: center; }
    .agent-stat-value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .agent-stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .capability-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
    .capability-item { background: var(--bg3); padding: 8px 14px; border-radius: 20px; font-size: 13px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
    .capability-item:hover { border-color: var(--accent); background: rgba(59,130,246,0.1); }
    .capability-item.selected { background: var(--accent); border-color: var(--accent); color: white; }
    .task-progress { margin: 16px 0; }
    .progress-bar { height: 8px; background: var(--bg3); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 4px; transition: width 0.3s; }
    .progress-text { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; }
    .goal-input { display: flex; gap: 10px; margin: 16px 0; }
    .goal-input input { flex: 1; padding: 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; }
    .goal-input input:focus { outline: none; border-color: var(--accent); }
    .goal-input button { padding: 12px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
    .goal-list { margin: 16px 0; }
    .goal-item { background: var(--bg3); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .goal-item-text { font-size: 14px; }
    .goal-item-status { padding: 4px 10px; border-radius: 12px; font-size: 11px; }
    .goal-item-status.pending { background: rgba(245,158,11,0.15); color: var(--warning); }
    .goal-item-status.running { background: rgba(59,130,246,0.15); color: var(--accent); }
    .goal-item-status.completed { background: rgba(16,185,129,0.15); color: var(--success); }
    .modal-header { padding: 18px 22px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 22px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text2); }
    .form-input, .form-select { width: 100%; padding: 12px 14px; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); }
    .modal-footer { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
    
    .empty { text-align: center; padding: 50px; color: var(--muted); }
    
    @media (max-width: 1200px) { .stats { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; } }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-icon">M</div>
        <span class="logo-text">MACP</span>
      </div>
      <div class="nav">
        <div class="nav-item active" id="nav-dashboard" onclick="showTab('dashboard')">ğŸ“Š æ§åˆ¶å°</div>
        <div class="nav-item" id="nav-agents" onclick="showTab('agents')">ğŸ¤– æ™ºèƒ½ä½“</div>
        <div class="nav-item" id="nav-tasks" onclick="showTab('tasks')">ğŸ“‹ ä»»åŠ¡</div>
        <div class="nav-item" id="nav-profit" onclick="showTab('profit')">ğŸ’° ç›ˆåˆ©</div>
        <div class="nav-item" id="nav-openclaw-chat" onclick="showTab('openclaw-chat')">ğŸ’¬ OpenClaw Chat</div>
        <div class="nav-item" id="nav-openclaw-agent" onclick="showTab('openclaw-agent')">ğŸ¤– OpenClaw Agent</div>
        <div class="nav-item" id="nav-developer" onclick="showTab('developer')">ğŸ’» å¼€å‘</div>
        <div class="nav-item" id="nav-logs" onclick="showTab('logs')">ğŸ“ æ—¥å¿—</div>
        <div class="nav-item" id="nav-openclaw-ext" data-url="http://localhost:18789">âœ¨ OpenClaw</div>
      </div>
    </aside>
    
    <main class="main">
      <header class="header">
        <h1 id="pageTitle">æ§åˆ¶å°</h1>
        <button class="btn btn-primary" onclick="openModal()">+ æ–°å»ºä»»åŠ¡</button>
      </header>
      
      <div class="content" id="content"></div>
    </main>
  </div>
  
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>åˆ›å»ºä»»åŠ¡</h3>
        <button class="btn btn-secondary" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ä»»åŠ¡åç§°</label>
          <input type="text" class="form-input" id="taskName" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
        </div>
        <div class="form-group">
          <label class="form-label">èƒ½åŠ›</label>
          <select class="form-select" id="taskCap">
            <option value="">é€‰æ‹©èƒ½åŠ›</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">æ“ä½œç±»å‹</label>
          <select class="form-select" id="taskAction" onchange="togglePrompt()">
            <option value="chat">AI å¯¹è¯</option>
            <option value="list_sessions">åˆ—å‡ºä¼šè¯</option>
          </select>
        </div>
        <div class="form-group" id="promptGroup">
          <label class="form-label">å¯¹è¯å†…å®¹</label>
          <input type="text" class="form-input" id="taskPrompt" placeholder="è¾“å…¥ä½ æƒ³é—®çš„å†…å®¹...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitTask()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <script>
    const hostname = window.location.hostname;
    const API = (hostname === 'localhost' || hostname === '127.0.0.1') 
      ? 'http://43.140.246.228:3000/api' 
      : `http://${hostname}:3000/api`;
    let agents = [], tasks = [], logs = [];
    let currentTab = 'dashboard';
    let profitData = {daily: {revenue: 0, costs: 0, profit: 0}, total: 0, breakdown: {}};
    let platformStats = [];
    
    let openclawSchedules = [];
    let ledgerData = null;
    let tradesData = null;
    let reportsData = [];
    
    async function fetchData() {
      try {
        const [a, t, l, p, ps, ocs, ledger, trades, reports] = await Promise.all([
          fetch(API + '/agents').then(r => r.json()).catch(() => []),
          fetch(API + '/tasks').then(r => r.json()).catch(() => []),
          fetch(API + '/logs').then(r => r.json()).catch(() => []),
          fetch(API + '/profit').then(r => r.json()).catch(() => ({daily: {revenue: 0, costs: 0, profit: 0}, total: 0, breakdown: {}})),
          fetch(API + '/content/platforms/all/stats').then(r => r.json()).catch(() => []),
          fetch(API + '/openclaw/schedules').then(r => r.json()).catch(() => []),
          fetch(API + '/openclaw/ledger').then(r => r.json()).catch(() => null),
          fetch(API + '/openclaw/trades').then(r => r.json()).catch(() => ({trades: []})),
          fetch(API + '/openclaw/reports').then(r => r.json()).catch(() => [])
        ]);
        agents = a || [];
        tasks = t || [];
        logs = Array.isArray(l) ? l.slice(-30) : [];
        profitData = p || {daily: {revenue: 0, costs: 0, profit: 0}, total: 0, breakdown: {}};
        platformStats = ps || [];
        openclawSchedules = ocs || [];
        ledgerData = ledger && !ledger.error ? ledger : null;
        tradesData = trades && trades.trades ? trades : {trades: []};
        reportsData = reports || [];
        render();
      } catch(e) { 
        console.error('Fetch error:', e); 
        document.getElementById('content').innerHTML = '<div class="empty">æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿ MACP æœåŠ¡æ­£åœ¨è¿è¡Œ</div>';
      }
    }
    
    function render() {
      const c = document.getElementById('content');
      if (!c) return;
      
      const caps = [...new Set(agents.flatMap(a => a.capabilities ? a.capabilities.map(c => c.name || c) : []))];
      const capNames = {
        chat: 'AIå¯¹è¯', invoke_tool: 'è°ƒç”¨å·¥å…·', list_sessions: 'åˆ—å‡ºä¼šè¯', session_management: 'ä¼šè¯ç®¡ç†', 
        code_generation: 'ä»£ç ç”Ÿæˆ', code_review: 'ä»£ç å®¡æŸ¥',
        article_generation: 'æ–‡ç« ç”Ÿæˆ', seo_optimization: 'SEOä¼˜åŒ–', content_publishing: 'å†…å®¹å‘å¸ƒ',
        product_research: 'å•†å“è°ƒç ”', listing_creation: 'å•†å“ä¸Šæ¶', customer_service: 'æ™ºèƒ½å®¢æœ',
        market_analysis: 'å¸‚åœºåˆ†æ', signal_generation: 'ä¿¡å·ç”Ÿæˆ', auto_trading: 'è‡ªåŠ¨äº¤æ˜“',
        api_management: 'APIç®¡ç†', usage_tracking: 'ç”¨é‡è¿½è¸ª', subscription_management: 'è®¢é˜…ç®¡ç†',
        content_review: 'å†…å®¹å®¡æ ¸', platform_publishing: 'å¹³å°å‘å¸ƒ', compliance_check: 'åˆè§„æ£€æŸ¥',
        portfolio_optimization: 'èµ„äº§é…ç½®', risk_assessment: 'é£é™©è¯„ä¼°', data_compliance: 'æ•°æ®åˆè§„'
      };
      const taskCapEl = document.getElementById('taskCap');
      if (taskCapEl) {
        taskCapEl.innerHTML = '<option value="">é€‰æ‹©èƒ½åŠ›</option>' + caps.map(x => '<option value="' + x + '">' + (capNames[x] || x) + '</option>').join('');
      }
      
      if (currentTab === 'dashboard') {
        const running = agents.filter(a => a.status === 'busy').length;
        const completed = tasks.filter(t => t.status === 'completed').length;
        const successRate = tasks.length ? Math.round(completed / tasks.length * 100) : 0;
        c.innerHTML = 
          '<div class="stats">' +
            '<div class="stat"><div class="stat-label">æ™ºèƒ½ä½“æ€»æ•°</div><div class="stat-value">' + agents.length + '</div></div>' +
            '<div class="stat"><div class="stat-label">è¿è¡Œä¸­</div><div class="stat-value">' + running + '</div></div>' +
            '<div class="stat"><div class="stat-label">ä»»åŠ¡æ€»æ•°</div><div class="stat-value">' + tasks.length + '</div></div>' +
            '<div class="stat"><div class="stat-label">æˆåŠŸç‡</div><div class="stat-value">' + successRate + '%</div></div>' +
          '</div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ“‹ æœ€è¿‘ä»»åŠ¡</h2></div>' +
            '<div class="tasks">' + 
              (tasks.slice(-8).reverse().map(t => 
                '<div class="task"><div class="task-info"><div class="task-name">' + t.name + '</div><div class="task-meta">' + new Date(t.createdAt).toLocaleString('zh-CN') + '</div></div><span class="task-status ' + t.status + '">' + 
                  (t.status === 'pending' ? 'ç­‰å¾…' : t.status === 'running' ? 'è¿è¡Œä¸­' : t.status === 'completed' ? 'å®Œæˆ' : 'å¤±è´¥') + 
                '</span></div>'
              ).join('') || '<div class="empty">æš‚æ— ä»»åŠ¡</div>') +
            '</div></div>';
      } else if (currentTab === 'agents') {
        c.innerHTML = '<div class="section"><div class="section-header"><h2 class="section-title">ğŸ¤– æ™ºèƒ½ä½“åˆ—è¡¨</h2></div>' +
          '<div class="agents">' + 
            (agents.map(a => 
              '<div class="agent" onclick="openAgentModal(\'' + a.id + '\')">' +
                '<div class="agent-header"><div class="agent-avatar ' + a.status + '">ğŸ¤–</div><span class="status-badge ' + a.status + '">' + 
                  (a.status === 'idle' ? 'ç©ºé—²' : a.status === 'busy' ? 'å¿™ç¢Œ' : 'é”™è¯¯') + 
                '</span></div>' +
                '<div class="agent-name">' + (a.name === 'Code Agent' ? 'ä»£ç æ™ºèƒ½ä½“' : a.name === 'OpenClaw Agent' ? 'OpenClawæ™ºèƒ½ä½“' : a.name === 'Content Agent' ? 'å†…å®¹åˆ›ä½œæ™ºèƒ½ä½“' : a.name === 'Ecommerce Agent' ? 'ç”µå•†è¿è¥æ™ºèƒ½ä½“' : a.name === 'Trading Agent' ? 'æŠ•èµ„é¡¾é—®æ™ºèƒ½ä½“' : a.name === 'SaaS Agent' ? 'SaaSæœåŠ¡æ™ºèƒ½ä½“' : a.name) + '</div>' +
                '<div class="agent-domain">' + (a.domain === 'Software Development' ? 'è½¯ä»¶å¼€å‘' : a.domain === 'AI Assistant' ? 'AIåŠ©æ‰‹' : a.domain === 'Content Creation' ? 'å†…å®¹åˆ›ä½œ' : a.domain === 'Ecommerce' ? 'ç”µå­å•†åŠ¡' : a.domain === 'Finance' ? 'é‡‘èç†è´¢' : a.domain === 'SaaS' ? 'SaaSæœåŠ¡' : a.domain) + '</div>' +
                '<div class="agent-desc">' + (a.description || '') + '</div>' +
                '<div class="caps">' + 
                  (a.capabilities ? a.capabilities.map(c => {
                    const name = c.name || c;
                    const cn = {
                      chat: 'AIå¯¹è¯', invoke_tool: 'è°ƒç”¨å·¥å…·', list_sessions: 'åˆ—å‡ºä¼šè¯', session_management: 'ä¼šè¯ç®¡ç†', 
                      code_generation: 'ä»£ç ç”Ÿæˆ', code_review: 'ä»£ç å®¡æŸ¥',
                      article_generation: 'æ–‡ç« ç”Ÿæˆ', seo_optimization: 'SEOä¼˜åŒ–', content_publishing: 'å†…å®¹å‘å¸ƒ', content_review: 'å†…å®¹å®¡æ ¸', platform_publishing: 'å¹³å°å‘å¸ƒ',
                      product_research: 'å•†å“è°ƒç ”', listing_creation: 'å•†å“ä¸Šæ¶', customer_service: 'æ™ºèƒ½å®¢æœ', compliance_check: 'åˆè§„æ£€æŸ¥',
                      market_analysis: 'å¸‚åœºåˆ†æ', signal_generation: 'ä¿¡å·ç”Ÿæˆ', portfolio_optimization: 'èµ„äº§é…ç½®', risk_assessment: 'é£é™©è¯„ä¼°',
                      api_management: 'APIç®¡ç†', usage_tracking: 'ç”¨é‡è¿½è¸ª', subscription_management: 'è®¢é˜…ç®¡ç†', data_compliance: 'æ•°æ®åˆè§„'
                    }[name] || name;
                    return '<span class="cap">' + cn + '</span>';
                  }).join('') : '') + 
                '</div></div>'
            ).join('') || '<div class="empty">æš‚æ— æ™ºèƒ½ä½“</div>') +
          '</div></div>';
      } else if (currentTab === 'tasks') {
        c.innerHTML = '<div class="section"><div class="section-header"><h2 class="section-title">ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</h2><button class="btn btn-primary" onclick="openModal()">+ æ–°å»º</button></div>' +
          '<div class="tasks">' + 
              (tasks.slice(-20).reverse().map(t => 
              '<div class="task" onclick="openTaskModal(\'' + t.id + '\')" style="cursor:pointer"><div class="task-info"><div class="task-name">' + t.name + '</div><div class="task-meta">' + 
                (t.input ? ((t.input.action === 'chat' ? 'AIå¯¹è¯' : t.input.action === 'list_sessions' ? 'åˆ—å‡ºä¼šè¯' : t.input.prompt || t.input.action || 'æ— ')) : 'æ— ') +
                (t.output && t.output.response ? ' â€¢ ' + t.output.response.substring(0, 40) + '...' : '') + 
              '</div></div><span class="task-status ' + t.status + '">' + 
                (t.status === 'pending' ? 'ç­‰å¾…' : t.status === 'running' ? 'è¿è¡Œä¸­' : t.status === 'completed' ? 'å®Œæˆ' : 'å¤±è´¥') + 
              '</span></div>'
            ).join('') || '<div class="empty">æš‚æ— ä»»åŠ¡</div>') +
          '</div></div>';
      } else if (currentTab === 'logs') {
        c.innerHTML = '<div class="section"><div class="section-header"><h2 class="section-title">ğŸ“ ç³»ç»Ÿæ—¥å¿—</h2></div>' +
          '<div class="tasks">' + 
              (logs.map(l => 
              '<div class="task"><div class="task-info"><div class="task-name"><span style="color:' + 
                (l.level === 'error' ? '#ef4444' : l.level === 'warn' ? '#f59e0b' : '#3b82f6') + '">' + 
                (l.level === 'error' ? 'é”™è¯¯' : l.level === 'warn' ? 'è­¦å‘Š' : l.level === 'info' ? 'ä¿¡æ¯' : (l.level || 'info').toUpperCase()) + 
              '</span></div><div class="task-meta">' +
                (l.timestamp ? new Date(l.timestamp).toLocaleString('zh-CN') : '') + ' â€¢ ' + (l.message || '') + 
              '</div></div></div>'
            ).join('') || '<div class="empty">æš‚æ— æ—¥å¿—</div>') +
          '</div></div>';
      } else if (currentTab === 'profit') {
        const profit = profitData || {daily: {revenue: 0, costs: 0, profit: 0}, total: 0, breakdown: {}};
        c.innerHTML = 
          '<div class="stats">' +
            '<div class="stat"><div class="stat-label">ä»Šæ—¥æ”¶å…¥</div><div class="stat-value" style="color:var(--success)">Â¥' + profit.daily.revenue.toFixed(2) + '</div></div>' +
            '<div class="stat"><div class="stat-label">ä»Šæ—¥æˆæœ¬</div><div class="stat-value" style="color:var(--error)">Â¥' + profit.daily.costs.toFixed(2) + '</div></div>' +
            '<div class="stat"><div class="stat-label">ä»Šæ—¥åˆ©æ¶¦</div><div class="stat-value" style="color:' + (profit.daily.profit >= 0 ? 'var(--success)' : 'var(--error)') + '">Â¥' + profit.daily.profit.toFixed(2) + '</div></div>' +
            '<div class="stat"><div class="stat-label">æ€»æ”¶å…¥</div><div class="stat-value">Â¥' + profit.total.toFixed(2) + '</div></div>' +
          '</div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">âœï¸ ä¸€é”®ç”Ÿæˆçˆ†æ¬¾å†…å®¹</h2></div>' +
            '<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px">' +
              '<div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">' +
                '<select id="contentPlatform" style="padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);min-width:140px">' +
                  '<option value="xiaohongshu">ğŸ“• å°çº¢ä¹¦</option>' +
                  '<option value="weibo">ğŸ“± å¾®åš</option>' +
                  '<option value="douyin">ğŸµ æŠ–éŸ³</option>' +
                  '<option value="toutiao">ğŸ“° å¤´æ¡</option>' +
                  '<option value="zhihu">ğŸ’¬ çŸ¥ä¹</option>' +
                  '<option value="bilibili">ğŸ“º Bç«™</option>' +
                '</select>' +
                '<input type="text" id="contentTopic" placeholder="è¾“å…¥ä¸»é¢˜ï¼Œå¦‚ï¼šAIåˆ›ä¸šã€å‰¯ä¸šèµšé’±" style="flex:1;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text)">' +
                '<button onclick="generateContent()" class="btn btn-primary" style="padding:12px 24px">ğŸš€ ç”Ÿæˆå†…å®¹</button>' +
              '</div>' +
              '<div id="generatedContent" style="display:none">' +
                '<div style="margin-bottom:12px"><strong>ğŸ“ ä¼˜åŒ–åæ ‡é¢˜:</strong></div>' +
                '<div id="contentTitle" style="background:var(--bg3);padding:12px;border-radius:8px;margin-bottom:16px;font-size:15px"></div>' +
                '<div style="margin-bottom:12px"><strong>ğŸ“„ å†…å®¹æ­£æ–‡:</strong></div>' +
                '<div id="contentBody" style="background:var(--bg3);padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;max-height:300px;overflow-y:auto;white-space:pre-wrap;line-height:1.6"></div>' +
                '<div style="margin-bottom:12px"><strong>#ï¸âƒ£ è¯é¢˜æ ‡ç­¾:</strong></div>' +
                '<div id="contentTags" style="margin-bottom:16px"></div>' +
                '<div style="margin-bottom:12px;color:var(--warning)"><strong>ğŸ’¡ å‘å¸ƒå»ºè®®:</strong> <span id="contentTips"></span></div>' +
                '<button onclick="copyContent()" class="btn btn-secondary" style="margin-right:10px">ğŸ“‹ å¤åˆ¶å†…å®¹</button>' +
              '</div>' +
              '<div id="contentLoading" style="display:none;text-align:center;padding:40px">' +
                '<div style="color:var(--muted)">å†…å®¹ç”Ÿæˆä¸­...</div>' +
              '</div>' +
            '</div></div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ’° ç›ˆåˆ©æ¨¡å¼</h2></div>' +
            '<div class="agents">' + 
              '<div class="agent"><div class="agent-header"><div class="agent-avatar idle">ğŸ“</div><span class="status-badge idle">è¿è¡Œä¸­</span></div><div class="agent-name">å†…å®¹åˆ›ä½œæ™ºèƒ½ä½“</div><div class="agent-domain">ä¸­å›½ç¤¾äº¤åª’ä½“å¹³å°å†…å®¹åˆ›ä½œä¸å‘å¸ƒ</div><div class="agent-desc">æŠ–éŸ³ã€ä»Šæ—¥å¤´æ¡ã€å¾®åšã€å°çº¢ä¹¦ã€çŸ¥ä¹ã€Bç«™ ä¸€é”®åˆ†å‘</div><div class="caps"><span class="cap">ğŸµæŠ–éŸ³</span><span class="cap">ğŸ“°å¤´æ¡</span><span class="cap">ğŸ“•å°çº¢ä¹¦</span><span class="cap">ğŸ’¬çŸ¥ä¹</span></div></div>' +
              '<div class="agent"><div class="agent-header"><div class="agent-avatar idle">ğŸ›’</div><span class="status-badge idle">è¿è¡Œä¸­</span></div><div class="agent-name">ç”µå•†ä»£è¿è¥</div><div class="agent-domain">æ”¯æŒæ·˜å®/äº¬ä¸œ/æŠ–éŸ³ç”µå•†åˆè§„è¿è¥</div><div class="agent-desc">å•†å“è°ƒç ”ã€Listingåˆ›å»ºã€æ™ºèƒ½å®¢æœã€æ¶ˆè´¹è€…æƒç›Šä¿æŠ¤</div><div class="caps"><span class="cap">é€‰å“åˆ†æ</span><span class="cap">è‡ªåŠ¨ä¸Šæ¶</span><span class="cap">åˆè§„å®¡æŸ¥</span></div></div>' +
              '<div class="agent"><div class="agent-header"><div class="agent-avatar ' + (profit.daily.profit >= 0 ? 'idle' : 'busy') + '">ğŸ“ˆ</div><span class="status-badge ' + (profit.daily.profit >= 0 ? 'idle' : 'busy') + '">' + (profit.daily.profit >= 0 ? 'åˆ†æä¸­' : 'åˆ†æä¸­') + '</span></div><div class="agent-name">æŠ•èµ„é¡¾é—®</div><div class="agent-domain">Aè‚¡/åŸºé‡‘/å€ºåˆ¸åˆ†æä¸èµ„äº§é…ç½®</div><div class="agent-desc">å¸‚åœºæ•°æ®åˆ†æã€æŠ•èµ„å»ºè®®ã€èµ„äº§é…ç½®ä¼˜åŒ–ã€é£é™©è¯„ä¼°ï¼ˆåˆè§„åˆ†æï¼Œä¸å«å®é™…äº¤æ˜“ï¼‰</div><div class="caps"><span class="cap">è¡Œæƒ…åˆ†æ</span><span class="cap">æŠ•èµ„å»ºè®®</span><span class="cap">é£é™©è¯„ä¼°</span></div></div>' +
              '<div class="agent"><div class="agent-header"><div class="agent-avatar idle">â˜ï¸</div><span class="status-badge idle">è¿è¡Œä¸­</span></div><div class="agent-name">SaaS API æœåŠ¡</div><div class="agent-domain">æä¾› AI API æœåŠ¡ï¼Œç¬¦åˆPIPLè¦æ±‚</div><div class="agent-desc">APIå¯†é’¥ç®¡ç†ã€ç”¨é‡ç»Ÿè®¡ã€è®¢é˜…è®¡è´¹ã€æ•°æ®å¢ƒå†…å­˜å‚¨</div><div class="caps"><span class="cap">APIç®¡ç†</span><span class="cap">ç”¨é‡è®¡è´¹</span><span class="cap">éšç§ä¿æŠ¤</span></div></div>' +
            '</div></div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ“± ä¸­å›½ç¤¾äº¤åª’ä½“å¹³å°</h2></div>' +
            '<div class="stats">' +
              (platformStats.length > 0 ? platformStats.map(ps => 
                '<div class="stat"><div class="stat-label">' + 
                (ps.platform === 'douyin' ? 'ğŸµ æŠ–éŸ³' : ps.platform === 'toutiao' ? 'ğŸ“° å¤´æ¡' : ps.platform === 'weibo' ? 'ğŸ“± å¾®åš' : ps.platform === 'xiaohongshu' ? 'ğŸ“• å°çº¢ä¹¦' : ps.platform === 'zhihu' ? 'ğŸ’¬ çŸ¥ä¹' : ps.platform === 'bilibili' ? 'ğŸ“º Bç«™' : ps.platform) + 
                '</div><div class="stat-value">' + ps.totalFollowers.toLocaleString() + ' ç²‰ä¸</div></div>'
              ).join('') : '<div class="stat"><div class="stat-label">ğŸµ æŠ–éŸ³</div><div class="stat-value">-</div></div><div class="stat"><div class="stat-label">ğŸ“° å¤´æ¡</div><div class="stat-value">-</div></div><div class="stat"><div class="stat-label">ğŸ“• å°çº¢ä¹¦</div><div class="stat-value">-</div></div><div class="stat"><div class="stat-label">ğŸ’¬ çŸ¥ä¹</div><div class="stat-value">-</div></div><div class="stat"><div class="stat-label">ğŸ“º Bç«™</div><div class="stat-value">-</div></div><div class="stat"><div class="stat-label">ğŸ“± å¾®åš</div><div class="stat-value">-</div></div>') +
            '</div></div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ“Š æ”¶å…¥åˆ†å¸ƒ</h2></div>' +
            '<div class="tasks">' + 
              (Object.entries(profit.breakdown).map(([source, amount]) => 
                '<div class="task"><div class="task-info"><div class="task-name">' + source + '</div><div class="task-meta">' + (source === 'ads' ? 'å¹¿å‘Šåˆ†æˆ' : source === 'sales' ? 'é”€å”®åˆ†æˆ' : source === 'trading' ? 'æŠ•èµ„åˆ†æ' : source === 'subscription' ? 'è®¢é˜…æ”¶å…¥' : source === 'api_call' ? 'APIè°ƒç”¨' : source) + '</div></div><span class="task-status completed">Â¥' + (amount || 0).toFixed(2) + '</span></div>'
              ).join('') || '<div class="empty">æš‚æ— æ”¶å…¥æ•°æ®</div>') +
            '</div></div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ“ˆ OpenClaw å®šæ—¶ä»»åŠ¡æŠ¥å‘Š</h2></div>' +
            '<div class="tasks">' + 
              (openclawSchedules.length > 0 ? openclawSchedules.map(s => 
                '<div class="task" onclick="openScheduleModal(\'' + s.id + '\')" style="cursor:pointer"><div class="task-info"><div class="task-name">' + (s.name || 'å®šæ—¶ä»»åŠ¡') + '</div><div class="task-meta">' + (s.description || 'OpenClaw å®šæ—¶ä»»åŠ¡') + '</div></div><span class="task-status ' + (s.status || 'idle') + '">' + (s.status === 'running' ? 'è¿è¡Œä¸­' : s.status === 'completed' ? 'å·²å®Œæˆ' : s.status === 'error' ? 'é”™è¯¯' : 'å¾…æ‰§è¡Œ') + '</span></div>'
              ).join('') : '<div class="empty">æš‚æ— å®šæ—¶ä»»åŠ¡ - è¯·åœ¨ OpenClaw ä¸­åˆ›å»ºå®šæ—¶ä»»åŠ¡</div>') +
            '</div></div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ“Š è™šæ‹Ÿè´¦æœ¬ - Aè‚¡å¥—åˆ©ç­–ç•¥</h2></div>' +
            (ledgerData ? 
              (() => {
                const positionValue = (ledgerData.positions || []).reduce((sum, p) => sum + (p.shares * p.avg_price), 0);
                const availableFunds = (ledgerData.current_capital || 0) - positionValue;
                return '<div class="stats">' +
                  '<div class="stat"><div class="stat-label">èµ·å§‹èµ„é‡‘</div><div class="stat-value" style="color:var(--text)">Â¥' + (ledgerData.initial_capital || 0).toLocaleString() + '</div></div>' +
                  '<div class="stat"><div class="stat-label">å½“å‰æŒä»“</div><div class="stat-value" style="color:var(--warning)">Â¥' + positionValue.toLocaleString() + '</div></div>' +
                  '<div class="stat"><div class="stat-label">å¯ç”¨èµ„é‡‘</div><div class="stat-value" style="color:var(--success)">Â¥' + availableFunds.toLocaleString() + '</div></div>' +
                  '<div class="stat"><div class="stat-label">ç´¯è®¡æ”¶ç›Š</div><div class="stat-value" style="color:' + ((ledgerData.total_profit || 0) >= 0 ? 'var(--success)' : 'var(--error)') + '">Â¥' + (ledgerData.total_profit || 0).toLocaleString() + ' (' + ((ledgerData.total_profit_rate || 0) * 100).toFixed(2) + '%)</div></div>' +
                '</div>';
              })() +
              '<div style="margin-top:16px"><strong>å½“å‰æŒä»“:</strong></div>' +
              '<div class="tasks" style="margin-top:8px">' + 
                ((ledgerData.positions?.length > 0) ? ledgerData.positions.map(p => 
                  '<div class="task"><div class="task-info"><div class="task-name">' + p.stock_name + ' (' + p.stock_code + ')</div><div class="task-meta">ä¹°å…¥ä»·: Â¥' + p.avg_price + ' Ã— ' + p.shares + 'è‚¡</div></div><span class="task-status completed">æŒä»“ä¸­</span></div>'
                ).join('') : '<div class="empty">æš‚æ— æŒä»“</div>') +
              '</div>' +
              '<div style="margin-top:16px"><strong>äº¤æ˜“è®°å½•:</strong></div>' +
              '<div class="tasks" style="margin-top:8px">' + 
                ((tradesData.trades?.length > 0) ? tradesData.trades.slice(-5).reverse().map(t => 
                  '<div class="task"><div class="task-info"><div class="task-name">' + t.stock_name + ' (' + t.stock_code + ')</div><div class="task-meta">' + t.date + ' ' + (t.action === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º') + ' Â¥' + t.price + ' Ã— ' + t.shares + 'è‚¡</div></div><span class="task-status ' + (t.action === 'BUY' ? 'running' : 'completed') + '">' + (t.action === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º') + '</span></div>'
                ).join('') : '<div class="empty">æš‚æ— äº¤æ˜“è®°å½•</div>') +
              '</div>' +
              ((reportsData.length > 0) ? 
                '<div style="margin-top:16px"><strong>æœ€æ–°æŠ¥å‘Š (' + reportsData[0].date + '):</strong></div><pre style="background:var(--bg3);padding:12px;border-radius:8px;margin-top:8px;font-size:12px;max-height:200px;overflow:auto">' + reportsData[0].content + '</pre>'
              : '') +
              '</div></div>' :
              '<div class="empty">æš‚æ— æ•°å€¼æ®ï¼Œè¯·ç¡®ä¿OpenClawè™šæ‹Ÿè´¦æœ¬è¿è¡Œæ­£å¸¸</div></div>') +
            '</div></div>';
      } else if (currentTab === 'openclaw-chat') {
        c.innerHTML = 
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ’¬ OpenClaw Chat</h2></div>' +
            '<div style="display:grid;grid-template-columns:1fr 2fr;gap:20px;height:calc(100vh - 200px)">' +
              '<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column">' +
                '<div style="font-weight:600;margin-bottom:12px">ğŸ“‹ ä¼šè¯åˆ—è¡¨ <button class="btn btn-secondary" style="float:right;padding:4px 8px;font-size:12px" onclick="newChat()">+ æ–°å»º</button></div>' +
                '<div id="sessionList" style="flex:1;overflow-y:auto">' +
                  '<div class="empty" style="padding:20px">æš‚æ— ä¼šè¯</div>' +
                '</div>' +
              '</div>' +
              '<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column">' +
                '<div style="font-weight:600;margin-bottom:12px" id="chatTitle">ğŸ’¬ æ–°å»ºå¯¹è¯</div>' +
                '<div id="chatMessages" style="flex:1;overflow-y:auto;background:var(--bg3);border-radius:8px;padding:12px;margin-bottom:12px">' +
                  '<div style="color:var(--muted);text-align:center;padding:40px">è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>' +
                '</div>' +
                '<div style="display:flex;gap:8px">' +
                  '<input type="text" id="chatInput" class="form-input" style="flex:1" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key===\'Enter\')sendChatMessage()">' +
                  '<button class="btn btn-primary" onclick="sendChatMessage()">å‘é€</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ› ï¸ å·¥å…·ç®±</h2></div>' +
            '<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px">' +
              '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">' +
                '<button class="btn btn-secondary" onclick="quickTool(\'list_sessions\')">ğŸ“‹ åˆ—å‡ºä¼šè¯</button>' +
                '<button class="btn btn-secondary" onclick="quickTool(\'schedules_list\')">â° å®šæ—¶ä»»åŠ¡</button>' +
                '<button class="btn btn-secondary" onclick="quickTool(\'tools_list\')">ğŸ”§ å¯ç”¨å·¥å…·</button>' +
                '<button class="btn btn-secondary" onclick="quickTool(\'market_data\')">ğŸ“ˆ å¸‚åœºæ•°æ®</button>' +
              '</div>' +
              '<div id="toolResult" style="display:none;background:var(--bg3);padding:12px;border-radius:8px;max-height:200px;overflow:auto;font-size:12px;white-space:pre-wrap"></div>' +
            '</div></div>';
      } else if (currentTab === 'openclaw-agent') {
        c.innerHTML = 
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">ğŸ¤– OpenClaw Agent ç®¡ç†</h2>' +
              '<button class="btn btn-primary" onclick="openNewAgentModal()">+ æ³¨å†Œæ–°æ™ºèƒ½ä½“</button></div>' +
            '<div class="agents">' + 
              (agents.map(a => 
                '<div class="agent" onclick="openAgentDetailModal(\'' + a.id + '\')" style="cursor:pointer">' +
                  '<div class="agent-header"><div class="agent-avatar ' + a.status + '">ğŸ¤–</div><span class="status-badge ' + a.status + '">' + 
                    (a.status === 'idle' ? 'ç©ºé—²' : a.status === 'busy' ? 'å¿™ç¢Œ' : 'é”™è¯¯') + 
                  '</span></div>' +
                  '<div class="agent-name">' + a.name + '</div>' +
                  '<div class="agent-domain">' + a.domain + '</div>' +
                  '<div class="agent-desc">' + (a.description || '') + '</div>' +
                  '<div class="caps">' + 
                    (a.capabilities ? a.capabilities.map(c => '<span class="cap">' + (c.name || c) + '</span>').join('') : '') + 
                  '</div>' +
                '</div>'
              ).join('') || '<div class="empty">æš‚æ— æ™ºèƒ½ä½“</div>') +
            '</div></div>' +
          '<div class="section">' +
            '<div class="section-header"><h2 class="section-title">âš™ï¸ Agent å·¥ä½œæµç¼–æ’</h2>' +
              '<button class="btn btn-primary" onclick="openWorkflowModal()">+ åˆ›å»ºå·¥ä½œæµ</button></div>' +
            '<div id="workflowList" class="tasks">' +
              '<div class="empty">æš‚æ— å·¥ä½œæµ</div>' +
            '</div></div>';
      } else if (currentTab === 'developer') {
        renderDeveloperTab(c);
      }
    }
    
    function showTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const nav = document.getElementById('nav-' + tab);
      if (nav) nav.classList.add('active');
      const titles = {dashboard: 'æ§åˆ¶å°', agents: 'æ™ºèƒ½ä½“', tasks: 'ä»»åŠ¡', profit: 'ç›ˆåˆ©', 'openclaw-chat': 'OpenClaw Chat', 'openclaw-agent': 'OpenClaw Agent', developer: 'å¼€å‘ä¸­å¿ƒ', logs: 'æ—¥å¿—'};
      document.getElementById('pageTitle').innerText = titles[tab];
      render();
    }
    
    function openModal() { document.getElementById('modal').classList.add('show'); }
    function closeModal() { 
      document.getElementById('modal').classList.remove('show');
    }
    function togglePrompt() {
      const action = document.getElementById('taskAction').value;
      document.getElementById('promptGroup').style.display = action === 'list_sessions' ? 'none' : 'block';
    }
    
    async function submitTask() {
      const name = document.getElementById('taskName').value;
      const cap = document.getElementById('taskCap').value;
      const action = document.getElementById('taskAction').value;
      const prompt = document.getElementById('taskPrompt').value;
      if (!name || !cap) return alert('è¯·å¡«å†™å®Œæ•´');
      
      const input = action === 'list_sessions' ? {action: 'list_sessions'} : {action: 'chat', prompt: prompt};
      await fetch(API + '/tasks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name, requiredCapabilities: [cap], input: input})
      });
      closeModal();
      fetchData();
    }

    let selectedAgent = null;
    let goals = [];

    function openAgentModal(agentId) {
      selectedAgent = agents.find(a => a.id === agentId);
      if (!selectedAgent) return;
      
      const m = document.getElementById('modal');
      const capNames = {
        chat: 'AIå¯¹è¯', invoke_tool: 'è°ƒç”¨å·¥å…·', list_sessions: 'åˆ—å‡ºä¼šè¯', session_management: 'ä¼šè¯ç®¡ç†', 
        code_generation: 'ä»£ç ç”Ÿæˆ', code_review: 'ä»£ç å®¡æŸ¥',
        article_generation: 'æ–‡ç« ç”Ÿæˆ', seo_optimization: 'SEOä¼˜åŒ–', content_publishing: 'å†…å®¹å‘å¸ƒ',
        product_research: 'å•†å“è°ƒç ”', listing_creation: 'å•†å“ä¸Šæ¶', customer_service: 'æ™ºèƒ½å®¢æœ',
        market_analysis: 'å¸‚åœºåˆ†æ', signal_generation: 'ä¿¡å·ç”Ÿæˆ', auto_trading: 'è‡ªåŠ¨äº¤æ˜“',
        api_management: 'APIç®¡ç†', usage_tracking: 'ç”¨é‡è¿½è¸ª', subscription_management: 'è®¢é˜…ç®¡ç†',
        content_review: 'å†…å®¹å®¡æ ¸', platform_publishing: 'å¹³å°å‘å¸ƒ', compliance_check: 'åˆè§„æ£€æŸ¥',
        portfolio_optimization: 'èµ„äº§é…ç½®', risk_assessment: 'é£é™©è¯„ä¼°', data_compliance: 'æ•°æ®åˆè§„'
      };
      
      const agentTasks = tasks.filter(t => t.assignedAgentId === agentId);
      const completedTasks = agentTasks.filter(t => t.status === 'completed').length;
      const runningTasks = agentTasks.filter(t => t.status === 'running').length;
      
      const nameMap = {'Code Agent': 'ä»£ç æ™ºèƒ½ä½“', 'OpenClaw Agent': 'OpenClawæ™ºèƒ½ä½“', 'Content Agent': 'å†…å®¹åˆ›ä½œæ™ºèƒ½ä½“', 'Ecommerce Agent': 'ç”µå•†è¿è¥æ™ºèƒ½ä½“', 'Trading Agent': 'æŠ•èµ„é¡¾é—®æ™ºèƒ½ä½“', 'SaaS Agent': 'SaaSæœåŠ¡æ™ºèƒ½ä½“', 'å†…å®¹åˆ›ä½œæ™ºèƒ½ä½“': 'å†…å®¹åˆ›ä½œæ™ºèƒ½ä½“', 'ç”µå•†è¿è¥æ™ºèƒ½ä½“': 'ç”µå•†è¿è¥æ™ºèƒ½ä½“', 'æŠ•èµ„é¡¾é—®æ™ºèƒ½ä½“': 'æŠ•èµ„é¡¾é—®æ™ºèƒ½ä½“', 'SaaSæœåŠ¡æ™ºèƒ½ä½“': 'SaaSæœåŠ¡æ™ºèƒ½ä½“'};
      
      m.innerHTML = 
        '<div class="modal-content modal-large">' +
          '<div class="modal-header">' +
            '<h3>' + (nameMap[selectedAgent.name] || selectedAgent.name) + '</h3>' +
            '<button class="btn btn-secondary" onclick="closeAgentModal()">âœ•</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="agent-detail-header">' +
              '<div class="agent-detail-avatar ' + selectedAgent.status + '" style="background: ' + (selectedAgent.status === 'idle' ? 'rgba(16,185,129,0.15)' : selectedAgent.status === 'busy' ? 'rgba(245,158,11,0.15)' : 'rgba(239,68,68,0.15)') + '">' + 
                (selectedAgent.name.includes('Content') ? 'ğŸ“' : selectedAgent.name.includes('Ecommerce') ? 'ğŸ›’' : selectedAgent.name.includes('Trading') ? 'ğŸ“ˆ' : selectedAgent.name.includes('SaaS') ? 'â˜ï¸' : selectedAgent.name.includes('Code') ? 'ğŸ’»' : 'ğŸ¤–') + 
              '</div>' +
              '<div class="agent-detail-info">' +
                '<div class="agent-detail-name">' + (nameMap[selectedAgent.name] || selectedAgent.name) + '</div>' +
                '<div class="agent-detail-domain">' + selectedAgent.domain + '</div>' +
                '<div class="agent-detail-desc">' + selectedAgent.description + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="agent-stats-grid">' +
              '<div class="agent-stat"><div class="agent-stat-value">' + agentTasks.length + '</div><div class="agent-stat-label">æ€»ä»»åŠ¡</div></div>' +
              '<div class="agent-stat"><div class="agent-stat-value">' + completedTasks + '</div><div class="agent-stat-label">å·²å®Œæˆ</div></div>' +
              '<div class="agent-stat"><div class="agent-stat-value">' + runningTasks + '</div><div class="agent-stat-label">è¿›è¡Œä¸­</div></div>' +
            '</div>' +
            '<h4 style="margin: 16px 0 8px;">é€‰æ‹©èƒ½åŠ›æ‰§è¡Œä»»åŠ¡</h4>' +
            '<div class="capability-list">' + 
              (selectedAgent.capabilities ? selectedAgent.capabilities.map(c => {
                const name = c.name || c;
                return '<span class="capability-item" onclick="selectCapability(this, \'' + name + '\')">' + (capNames[name] || name) + '</span>';
              }).join('') : '') + 
            '</div>' +
            '<div id="taskConfigArea" style="display:none;">' +
              '<div class="form-group" style="margin-top:16px;">' +
                '<label class="form-label">ä»»åŠ¡ç›®æ ‡</label>' +
                '<input type="text" class="form-input" id="taskGoal" placeholder="ä¾‹å¦‚ï¼šç”Ÿæˆä¸€ç¯‡å…³äºAIçš„æ–‡ç« ï¼Œå‘å¸ƒåˆ°å°çº¢ä¹¦">' +
              '</div>' +
              '<div class="form-group">' +
                '<label class="form-label">å‚æ•°è®¾ç½®</label>' +
                '<input type="text" class="form-input" id="taskParams" placeholder="å¯é€‰ï¼šè®¾ç½®ç‰¹å®šå‚æ•°">' +
              '</div>' +
              '<button class="btn btn-primary" style="width:100%;margin-top:12px;" onclick="executeTask()">â–¶ æ‰§è¡Œä»»åŠ¡</button>' +
            '</div>' +
            '<h4 style="margin: 20px 0 8px;">æ‰§è¡Œç›®æ ‡</h4>' +
            '<div class="goal-input">' +
              '<input type="text" id="newGoal" placeholder="è®¾å®šæ™ºèƒ½ä½“ç›®æ ‡...">' +
              '<button onclick="addGoal()">+ æ·»åŠ </button>' +
            '</div>' +
            '<div class="goal-list" id="goalList">' +
              goals.filter(g => g.agentId === agentId).map(g => 
                '<div class="goal-item"><span class="goal-item-text">' + g.text + '</span><span class="goal-item-status ' + g.status + '">' + (g.status === 'pending' ? 'å¾…æ‰§è¡Œ' : g.status === 'running' ? 'æ‰§è¡Œä¸­' : 'å·²å®Œæˆ') + '</span></div>'
              ).join('') || '<div class="empty" style="padding:20px">æš‚æ— ç›®æ ‡ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ </div>' +
            '</div>' +
            '<h4 style="margin: 20px 0 8px;">ä»»åŠ¡è¿›åº¦</h4>' +
            '<div class="tasks">' + 
              (agentTasks.slice(-5).reverse().map(t => 
                '<div class="task"><div class="task-info"><div class="task-name">' + t.name + '</div><div class="task-meta">' + new Date(t.createdAt).toLocaleString('zh-CN') + '</div></div><span class="task-status ' + t.status + '">' + 
                  (t.status === 'pending' ? 'ç­‰å¾…' : t.status === 'running' ? 'è¿è¡Œä¸­' : t.status === 'completed' ? 'å®Œæˆ' : 'å¤±è´¥') + 
                '</span></div>'
              ).join('') || '<div class="empty" style="padding:20px">æš‚æ— ä»»åŠ¡æ‰§è¡Œè®°å½•</div>') +
            '</div>' +
          '</div>' +
        '</div>';
      m.classList.add('show');
    }

    function closeAgentModal() {
      document.getElementById('modal').classList.remove('show');
      selectedAgent = null;
      selectedCapability = null;
    }

    let selectedCapability = null;

    function selectCapability(el, cap) {
      document.querySelectorAll('.capability-item').forEach(i => i.classList.remove('selected'));
      el.classList.add('selected');
      selectedCapability = cap;
      document.getElementById('taskConfigArea').style.display = 'block';
    }

    async function executeTask() {
      if (!selectedAgent || !selectedCapability) return alert('è¯·å…ˆé€‰æ‹©èƒ½åŠ›');
      const goal = document.getElementById('taskGoal').value;
      const params = document.getElementById('taskParams').value;
      if (!goal) return alert('è¯·è¾“å…¥ä»»åŠ¡ç›®æ ‡');
      
      const taskInput = {
        action: selectedCapability.includes('chat') ? 'chat' : selectedCapability,
        prompt: goal,
        ...(params ? JSON.parse(params) : {})
      };
      
      await fetch(API + '/tasks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          name: goal,
          requiredCapabilities: [selectedCapability],
          input: taskInput
        })
      });
      
      alert('ä»»åŠ¡å·²æäº¤æ‰§è¡Œ');
      closeAgentModal();
      fetchData();
    }

    function addGoal() {
      if (!selectedAgent) return;
      const text = document.getElementById('newGoal').value;
      if (!text) return;
      
      goals.push({id: Date.now(), agentId: selectedAgent.id, text: text, status: 'pending'});
      document.getElementById('newGoal').value = '';
      openAgentModal(selectedAgent.id);
    }

    function openTaskModal(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      const m = document.getElementById('modal');
      const statusText = {pending: 'ç­‰å¾…ä¸­', running: 'æ‰§è¡Œä¸­', completed: 'å·²å®Œæˆ', failed: 'å¤±è´¥'};
      
      let outputContent = '';
      if (task.output) {
        if (task.output.output) outputContent = task.output.output;
        else if (task.output.response) outputContent = task.output.response;
        else if (task.output.error) outputContent = 'é”™è¯¯: ' + task.output.error;
        else outputContent = JSON.stringify(task.output, null, 2);
      } else {
        outputContent = 'æ— è¾“å‡º';
      }
      
      m.innerHTML = 
        '<div class="modal-content modal-large">' +
          '<div class="modal-header">' +
            '<h3>ğŸ“‹ ä»»åŠ¡è¯¦æƒ…</h3>' +
            '<button class="btn btn-secondary" onclick="closeModal()">âœ•</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div style="margin-bottom:16px"><strong>ä»»åŠ¡åç§°:</strong> ' + task.name + '</div>' +
            '<div style="margin-bottom:16px"><strong>çŠ¶æ€:</strong> <span class="task-status ' + task.status + '">' + statusText[task.status] + '</span></div>' +
            '<div style="margin-bottom:16px"><strong>åˆ›å»ºæ—¶é—´:</strong> ' + new Date(task.createdAt).toLocaleString('zh-CN') + '</div>' +
            (task.startedAt ? '<div style="margin-bottom:16px"><strong>å¼€å§‹æ—¶é—´:</strong> ' + new Date(task.startedAt).toLocaleString('zh-CN') + '</div>' : '') +
            (task.completedAt ? '<div style="margin-bottom:16px"><strong>å®Œæˆæ—¶é—´:</strong> ' + new Date(task.completedAt).toLocaleString('zh-CN') + '</div>' : '') +
            '<div style="margin-bottom:16px"><strong>è¾“å…¥:</strong></div>' +
            '<pre style="background:var(--bg3);padding:12px;border-radius:8px;overflow-x:auto;margin-bottom:16px;font-size:13px;">' + 
            JSON.stringify(task.input, null, 2) + '</pre>' +
            '<div style="margin-bottom:16px"><strong>è¾“å‡ºç»“æœ:</strong></div>' +
            '<pre style="background:var(--bg3);padding:12px;border-radius:8px;overflow-x:auto;font-size:13px;max-height:400px;">' + outputContent + '</pre>' +
          '</div>' +
        '</div>';
      m.classList.add('show');
    }

    let generatedContentData = null;
    let openclawSessions = [];
    let currentSessionId = null;
    let chatHistory = [];
    let currentChatId = 'chat-' + Date.now();

    async function generateContent() {
      const platform = document.getElementById('contentPlatform').value;
      const topic = document.getElementById('contentTopic').value;
      
      if (!topic) return alert('è¯·è¾“å…¥å†…å®¹ä¸»é¢˜');
      
      document.getElementById('generatedContent').style.display = 'none';
      document.getElementById('contentLoading').style.display = 'block';
      
      try {
        const res = await fetch(API + '/content/generate-ready', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({platform, topic, keywords: topic.split(/[,ï¼Œ]/).filter(k => k.trim())})
        });
        const data = await res.json();
        
        generatedContentData = data;
        
        if (data.optimized) {
          document.getElementById('contentTitle').textContent = data.optimized.title || data.original.title || '';
          document.getElementById('contentBody').textContent = data.optimized.content || data.original.body || '';
          
          const tags = data.optimized.hashtags || data.original.tags || [];
          document.getElementById('contentTags').innerHTML = tags.map(t => '<span class="cap" style="margin-right:8px;margin-bottom:8px">' + t + '</span>').join('');
          
          document.getElementById('contentTips').textContent = data.optimized.tips || 'æ— ç‰¹åˆ«å»ºè®®';
        } else {
          document.getElementById('contentTitle').textContent = data.original?.title || '';
          document.getElementById('contentBody').textContent = data.original?.body || JSON.stringify(data, null, 2);
          document.getElementById('contentTips').textContent = 'ç”Ÿæˆå®Œæˆï¼Œè¯·å¤åˆ¶å†…å®¹åæ‰‹åŠ¨å‘å¸ƒ';
        }
        
        document.getElementById('contentLoading').style.display = 'none';
        document.getElementById('generatedContent').style.display = 'block';
      } catch (e) {
        alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
        document.getElementById('contentLoading').style.display = 'none';
      }
    }

    function copyContent() {
      if (!generatedContentData) return;
      const text = document.getElementById('contentTitle').textContent + '\n\n' + document.getElementById('contentBody').textContent;
      navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'));
    }

    async function openScheduleModal(scheduleId) {
      const schedule = openclawSchedules.find(s => s.id === scheduleId);
      if (!schedule) return;
      
      const m = document.getElementById('modal');
      
      let reportContent = '';
      if (schedule.last_report) {
        reportContent = schedule.last_report;
      } else if (schedule.output) {
        reportContent = typeof schedule.output === 'string' ? schedule.output : JSON.stringify(schedule.output, null, 2);
      } else if (schedule.result) {
        reportContent = typeof schedule.result === 'string' ? schedule.result : JSON.stringify(schedule.result, null, 2);
      } else {
        reportContent = 'æš‚æ— æŠ¥å‘Šè¾“å‡º';
      }
      
      m.innerHTML = 
        '<div class="modal-content modal-large">' +
          '<div class="modal-header">' +
            '<h3>ğŸ“ˆ ' + (schedule.name || 'å®šæ—¶ä»»åŠ¡') + '</h3>' +
            '<button class="btn btn-secondary" onclick="closeModal()">âœ•</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div style="margin-bottom:16px"><strong>ä»»åŠ¡ID:</strong> ' + schedule.id + '</div>' +
            '<div style="margin-bottom:16px"><strong>çŠ¶æ€:</strong> <span class="task-status ' + (schedule.status || 'idle') + '">' + (schedule.status === 'running' ? 'è¿è¡Œä¸­' : schedule.status === 'completed' ? 'å·²å®Œæˆ' : schedule.status === 'error' ? 'é”™è¯¯' : 'å¾…æ‰§è¡Œ') + '</span></div>' +
            '<div style="margin-bottom:16px"><strong>æè¿°:</strong> ' + (schedule.description || 'æ— ') + '</div>' +
            (schedule.schedule ? '<div style="margin-bottom:16px"><strong>æ‰§è¡Œè®¡åˆ’:</strong> ' + schedule.schedule + '</div>' : '') +
            (schedule.last_run ? '<div style="margin-bottom:16px"><strong>æœ€åæ‰§è¡Œ:</strong> ' + new Date(schedule.last_run).toLocaleString('zh-CN') + '</div>' : '') +
            '<div style="margin-bottom:16px"><strong>ä»»åŠ¡æŠ¥å‘Š:</strong></div>' +
            '<pre style="background:var(--bg3);padding:12px;border-radius:8px;overflow-x:auto;font-size:13px;max-height:400px;">' + reportContent + '</pre>' +
            '<button class="btn btn-primary" style="margin-top:12px" onclick="runSchedule(\'' + schedule.id + '\')">â–¶ ç«‹å³æ‰§è¡Œ</button>' +
          '</div>' +
        '</div>';
      m.classList.add('show');
    }

    async function runSchedule(scheduleId) {
      if (!confirm('ç¡®å®šè¦ç«‹å³æ‰§è¡Œæ­¤å®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) return;
      
      try {
        const res = await fetch(API + '/openclaw/schedules/' + scheduleId + '/run', {
          method: 'POST'
        });
        const result = await res.json();
        alert('ä»»åŠ¡å·²å¼€å§‹æ‰§è¡Œ');
        fetchData();
      } catch (e) {
        alert('æ‰§è¡Œå¤±è´¥: ' + e.message);
      }
    }

    function openNewAgentModal() {
      const m = document.getElementById('modal');
      m.innerHTML = 
        '<div class="modal-content modal-large">' +
          '<div class="modal-header">' +
            '<h3>ğŸ¤– æ³¨å†Œæ–°æ™ºèƒ½ä½“</h3>' +
            '<button class="btn btn-secondary" onclick="closeModal()">âœ•</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="form-group"><label class="form-label">æ™ºèƒ½ä½“ID</label><input type="text" class="form-input" id="newAgentId" placeholder="å¦‚ï¼šmy-agent-001"></div>' +
            '<div class="form-group"><label class="form-label">åç§°</label><input type="text" class="form-input" id="newAgentName" placeholder="å¦‚ï¼šæˆ‘çš„AIåŠ©æ‰‹"></div>' +
            '<div class="form-group"><label class="form-label">é¢†åŸŸ</label><input type="text" class="form-input" id="newAgentDomain" placeholder="å¦‚ï¼šè½¯ä»¶å¼€å‘"></div>' +
            '<div class="form-group"><label class="form-label">æè¿°</label><textarea class="form-input" id="newAgentDesc" placeholder="æ™ºèƒ½ä½“åŠŸèƒ½æè¿°" rows="3"></textarea></div>' +
            '<div class="form-group"><label class="form-label">SOUL.md é…ç½®</label></div>' +
            '<div class="form-group"><label class="form-label">è§’è‰²</label><input type="text" class="form-input" id="soulRole" placeholder="å¦‚ï¼šä¸“ä¸šç¨‹åºå‘˜"></div>' +
            '<div class="form-group"><label class="form-label">äººæ ¼ç‰¹å¾</label><textarea class="form-input" id="soulPersonality" placeholder="å¦‚ï¼šä¸¥è°¨ã€é«˜æ•ˆã€æ³¨é‡ä»£ç è´¨é‡" rows="2"></textarea></div>' +
            '<div class="form-group"><label class="form-label">ä¸“ä¸šé¢†åŸŸ</label><input type="text" class="form-input" id="soulExpertise" placeholder="å¦‚ï¼šPython,JavaScript,ç³»ç»Ÿè®¾è®¡ï¼ˆé€—å·åˆ†éš”ï¼‰"></div>' +
            '<div class="form-group"><label class="form-label">å·¥ä½œé£æ ¼</label><input type="text" class="form-input" id="soulWorkingStyle" placeholder="å¦‚ï¼šå¿«é€Ÿè¿­ä»£ã€æ–‡æ¡£å®Œå–„"></div>' +
            '<button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="registerNewAgent()">æ³¨å†Œæ™ºèƒ½ä½“</button>' +
          '</div>' +
        '</div>';
      m.classList.add('show');
    }

    async function registerNewAgent() {
      const id = document.getElementById('newAgentId').value;
      const name = document.getElementById('newAgentName').value;
      const domain = document.getElementById('newAgentDomain').value;
      const description = document.getElementById('newAgentDesc').value;
      
      if (!id || !name) return alert('è¯·å¡«å†™æ™ºèƒ½ä½“IDå’Œåç§°');
      
      const expertise = document.getElementById('soulExpertise').value.split(',').map(s => s.trim()).filter(s => s);
      
      const soul = {
        role: document.getElementById('soulRole').value || name,
        personality: document.getElementById('soulPersonality').value || 'ä¸“ä¸šã€é«˜æ•ˆ',
        expertise: expertise,
        workingStyle: document.getElementById('soulWorkingStyle').value || 'å¿«é€Ÿè¿­ä»£',
        communicationStyle: 'æ¸…æ™°ã€ç›´æ¥',
        goals: ['å®Œæˆç”¨æˆ·ä»»åŠ¡', 'æä¾›é«˜è´¨é‡è¾“å‡º'],
        constraints: ['éµå®ˆå®‰å…¨è§„èŒƒ', 'ä¸è¾“å‡ºæœ‰å®³å†…å®¹']
      };
      
      try {
        const res = await fetch(API + '/agents', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            id,
            name,
            domain,
            description,
            capabilities: [{ name: 'chat', description: 'é€šç”¨å¯¹è¯' }],
            soul
          })
        });
        
        if (res.ok) {
          alert('æ™ºèƒ½ä½“æ³¨å†ŒæˆåŠŸï¼');
          closeModal();
          fetchData();
        } else {
          const err = await res.json();
          alert('æ³¨å†Œå¤±è´¥: ' + (err.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        alert('æ³¨å†Œå¤±è´¥: ' + e.message);
      }
    }

    function openAgentDetailModal(agentId) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      
      const m = document.getElementById('modal');
      const soul = agent.soul || {};
      
      m.innerHTML = 
        '<div class="modal-content modal-large">' +
          '<div class="modal-header">' +
            '<h3>ğŸ¤– ' + agent.name + '</h3>' +
            '<button class="btn btn-secondary" onclick="closeModal()">âœ•</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="stats" style="grid-template-columns:repeat(2,1fr)">' +
              '<div class="stat"><div class="stat-label">çŠ¶æ€</div><div class="stat-value">' + (agent.status === 'idle' ? 'ç©ºé—²' : agent.status === 'busy' ? 'å¿™ç¢Œ' : 'é”™è¯¯') + '</div></div>' +
              '<div class="stat"><div class="stat-label">å½“å‰ä»»åŠ¡</div><div class="stat-value">' + (agent.currentTasks || 0) + '</div></div>' +
            '</div>' +
            '<div style="margin-top:16px"><strong>é¢†åŸŸï¼š</strong>' + agent.domain + '</div>' +
            '<div style="margin-top:8px"><strong>æè¿°ï¼š</strong>' + (agent.description || 'æ— ') + '</div>' +
            '<div style="margin-top:16px"><strong>èƒ½åŠ›ï¼š</strong></div>' +
            '<div class="caps" style="margin-top:8px">' + 
              (agent.capabilities ? agent.capabilities.map(c => '<span class="cap">' + (c.description || c.name) + '</span>').join('') : 'æ— ') + 
            '</div>' +
            '<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">' +
              '<div style="margin-bottom:12px"><strong>ğŸ“ SOUL.md é…ç½®</strong></div>' +
              '<div style="margin-bottom:8px"><strong>è§’è‰²ï¼š</strong>' + (soul.role || 'æœªè®¾ç½®') + '</div>' +
              '<div style="margin-bottom:8px"><strong>äººæ ¼ï¼š</strong>' + (soul.personality || 'æœªè®¾ç½®') + '</div>' +
              '<div style="margin-bottom:8px"><strong>ä¸“ä¸šï¼š</strong>' + ((soul.expertise || []).join(', ') || 'æœªè®¾ç½®') + '</div>' +
              '<div style="margin-bottom:8px"><strong>å·¥ä½œé£æ ¼ï¼š</strong>' + (soul.workingStyle || 'æœªè®¾ç½®') + '</div>' +
              '<div style="margin-bottom:8px"><strong>æ²Ÿé€šé£æ ¼ï¼š</strong>' + (soul.communicationStyle || 'æœªè®¾ç½®') + '</div>' +
              '<button class="btn btn-secondary" style="margin-top:12px" onclick="editAgentSOUL(\'' + agent.id + '\')">ç¼–è¾‘ SOUL</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      m.classList.add('show');
    }

    function editAgentSOUL(agentId) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      
      const soul = agent.soul || {};
      
      const m = document.getElementById('modal');
      m.innerHTML = 
        '<div class="modal-content modal-large">' +
          '<div class="modal-header">' +
            '<h3>ğŸ“ ç¼–è¾‘ SOUL.md - ' + agent.name + '</h3>' +
            '<button class="btn btn-secondary" onclick="closeModal()">âœ•</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="form-group"><label class="form-label">è§’è‰²</label><input type="text" class="form-input" id="editSoulRole" value="' + (soul.role || '') + '"></div>' +
            '<div class="form-group"><label class="form-label">äººæ ¼ç‰¹å¾</label><textarea class="form-input" id="editSoulPersonality" rows="2">' + (soul.personality || '') + '</textarea></div>' +
            '<div class="form-group"><label class="form-label">ä¸“ä¸šé¢†åŸŸï¼ˆé€—å·åˆ†éš”ï¼‰</label><input type="text" class="form-input" id="editSoulExpertise" value="' + ((soul.expertise || []).join(',')) + '"></div>' +
            '<div class="form-group"><label class="form-label">å·¥ä½œé£æ ¼</label><input type="text" class="form-input" id="editSoulWorkingStyle" value="' + (soul.workingStyle || '') + '"></div>' +
            '<div class="form-group"><label class="form-label">æ²Ÿé€šé£æ ¼</label><input type="text" class="form-input" id="editSoulCommunicationStyle" value="' + (soul.communicationStyle || '') + '"></div>' +
            '<button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="saveAgentSOUL(\'' + agent.id + '\')">ä¿å­˜ SOUL é…ç½®</button>' +
          '</div>' +
        '</div>';
      m.classList.add('show');
    }

    async function saveAgentSOUL(agentId) {
      const expertise = document.getElementById('editSoulExpertise').value.split(',').map(s => s.trim()).filter(s => s);
      
      const soul = {
        role: document.getElementById('editSoulRole').value,
        personality: document.getElementById('editSoulPersonality').value,
        expertise: expertise,
        workingStyle: document.getElementById('editSoulWorkingStyle').value,
        communicationStyle: document.getElementById('editSoulCommunicationStyle').value,
        goals: ['å®Œæˆç”¨æˆ·ä»»åŠ¡', 'æä¾›é«˜è´¨é‡è¾“å‡º'],
        constraints: ['éµå®ˆå®‰å…¨è§„èŒƒ']
      };
      
      try {
        const res = await fetch(API + '/agents/' + agentId + '/soul', {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(soul)
        });
        
        if (res.ok) {
          alert('SOUL é…ç½®ä¿å­˜æˆåŠŸï¼');
          closeModal();
          fetchData();
        } else {
          alert('ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        alert('ä¿å­˜å¤±è´¥: ' + e.message);
      }
    }

    function openWorkflowModal() {
      const m = document.getElementById('modal');
      const agentOptions = agents.map(a => '<option value="' + a.id + '">' + a.name + '</option>').join('');
      
      m.innerHTML = 
        '<div class="modal-content modal-large">' +
          '<div class="modal-header">' +
            '<h3>âš™ï¸ åˆ›å»º Agent å·¥ä½œæµ</h3>' +
            '<button class="btn btn-secondary" onclick="closeModal()">âœ•</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="form-group"><label class="form-label">å·¥ä½œæµåç§°</label><input type="text" class="form-input" id="workflowName" placeholder="å¦‚ï¼šå¤šæ™ºèƒ½ä½“åä½œä»»åŠ¡"></div>' +
            '<div class="form-group"><label class="form-label">æè¿°</label><textarea class="form-input" id="workflowDesc" placeholder="å·¥ä½œæµæè¿°" rows="2"></textarea></div>' +
            '<div class="form-group"><label class="form-label">æ­¥éª¤1 - æ™ºèƒ½ä½“</label><select class="form-input" id="step1Agent">' + agentOptions + '</select></div>' +
            '<div class="form-group"><label class="form-label">æ­¥éª¤1 - åŠ¨ä½œ</label><input type="text" class="form-input" id="step1Action" placeholder="å¦‚ï¼šchat"></div>' +
            '<div class="form-group"><label class="form-label">æ­¥éª¤1 - è¾“å…¥</label><textarea class="form-input" id="step1Input" placeholder="{"prompt":"ä»»åŠ¡æè¿°"}" rows="2"></textarea></div>' +
            '<div style="margin-top:16px;padding:12px;background:var(--bg3);border-radius:8px;color:var(--text2);font-size:12px">' +
              'ğŸ’¡ å·¥ä½œæµæ”¯æŒå¤šæ­¥éª¤é¡ºåºæ‰§è¡Œï¼Œæ¯ä¸ªæ­¥éª¤å¯ä»¥æŒ‡å®šä¸åŒçš„æ™ºèƒ½ä½“ï¼Œå‰ä¸€æ­¥çš„è¾“å‡ºå°†ä½œä¸ºä¸‹ä¸€æ­¥çš„è¾“å…¥ã€‚' +
            '</div>' +
            '<button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="createWorkflow()">åˆ›å»ºå·¥ä½œæµ</button>' +
          '</div>' +
        '</div>';
      m.classList.add('show');
    }

    async function createWorkflow() {
      const name = document.getElementById('workflowName').value;
      const description = document.getElementById('workflowDesc').value;
      const step1Agent = document.getElementById('step1Agent').value;
      const step1Action = document.getElementById('step1Action').value;
      const step1Input = document.getElementById('step1Input').value;
      
      if (!name || !step1Agent || !step1Action) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      
      let input = {};
      try {
        if (step1Input) input = JSON.parse(step1Input);
      } catch (e) {
        input = { prompt: step1Input };
      }
      
      const steps = [{
        id: 'step-1',
        agentId: step1Agent,
        action: step1Action,
        input: input,
        dependsOn: []
      }];
      
      try {
        const res = await fetch(API + '/agent-workflows', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name, description, steps })
        });
        
        if (res.ok) {
          alert('å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼');
          closeModal();
          fetchData();
        } else {
          alert('åˆ›å»ºå¤±è´¥');
        }
      } catch (e) {
        alert('åˆ›å»ºå¤±è´¥: ' + e.message);
      }
    }

    fetchData();
    setInterval(fetchData, 5000);

    async function loadOpenClawSessions() {
      try {
        const task = await fetch(API + '/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: 'list_sessions',
            requiredCapabilities: ['list_sessions'],
            input: { action: 'list_sessions' }
          })
        });
        const taskData = await task.json();
        
        setTimeout(async () => {
          const tasks = await fetch(API + '/tasks').then(r => r.json());
          const listTask = tasks.find(t => t.id === taskData.id);
          if (listTask && listTask.output && listTask.output.sessions) {
            openclawSessions = listTask.output.sessions;
            renderSessionList();
          }
        }, 2000);
      } catch (e) {
        console.error('Failed to load sessions:', e);
      }
    }

    function renderSessionList() {
      const el = document.getElementById('sessionList');
      if (!el) return;
      
      if (openclawSessions.length === 0) {
        el.innerHTML = '<div class="empty" style="padding:20px">æš‚æ— ä¼šè¯</div>';
        return;
      }
      
      el.innerHTML = openclawSessions.map(s => 
        '<div class="task" onclick="selectSession(\'' + s.id + '\')" style="cursor:pointer;margin-bottom:8px">' +
          '<div class="task-info"><div class="task-name">' + (s.name || 'æœªå‘½åä¼šè¯') + '</div>' +
          '<div class="task-meta">' + (s.created_at ? new Date(s.created_at).toLocaleString('zh-CN') : '') + '</div></div>' +
          '<span class="task-status idle" onclick="event.stopPropagation();deleteSession(\'' + s.id + '\')">âœ•</span>' +
        '</div>'
      ).join('');
    }

    async function createOpenClawSession() {
      const name = prompt('è¯·è¾“å…¥ä¼šè¯åç§°:');
      if (!name) return;
      
      try {
        const task = await fetch(API + '/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: 'create_session_' + Date.now(),
            requiredCapabilities: ['session_management'],
            input: { action: 'session_management', subaction: 'create', name: name }
          })
        });
        
        alert('ä¼šè¯åˆ›å»ºæˆåŠŸï¼');
        loadOpenClawSessions();
      } catch (e) {
        alert('åˆ›å»ºå¤±è´¥: ' + e.message);
      }
    }

    function selectSession(sessionId) {
      currentSessionId = sessionId;
      const session = openclawSessions.find(s => s.id === sessionId);
      document.getElementById('chatTitle').innerText = 'ğŸ’¬ ' + (session?.name || 'å¯¹è¯');
      chatHistory = [];
      renderChatMessages();
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      chatHistory.push({ role: 'user', content: message });
      input.value = '';
      renderChatMessages();
      
      try {
        const task = await fetch(API + '/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: 'chat_' + Date.now(),
            requiredCapabilities: ['chat'],
            input: { action: 'chat', prompt: message }
          })
        });
        const taskData = await task.json();
        
        setTimeout(async () => {
          const tasks = await fetch(API + '/tasks').then(r => r.json());
          const chatTask = tasks.find(t => t.id === taskData.id);
          if (chatTask && chatTask.output && chatTask.output.response) {
            chatHistory.push({ role: 'assistant', content: chatTask.output.response });
          } else if (chatTask && chatTask.output && chatTask.output.output) {
            chatHistory.push({ role: 'assistant', content: chatTask.output.output });
          } else {
            chatHistory.push({ role: 'assistant', content: 'ï¼ˆæ— å“åº”ï¼‰' });
          }
          renderChatMessages();
        }, 5000);
      } catch (e) {
        chatHistory.push({ role: 'assistant', content: 'å‘é€å¤±è´¥: ' + e.message });
        renderChatMessages();
      }
    }

    function newChat() {
      currentChatId = 'chat-' + Date.now();
      chatHistory = [];
      document.getElementById('chatTitle').innerText = 'ğŸ’¬ æ–°å»ºå¯¹è¯';
      renderChatMessages();
    }

    async function quickTool(toolName) {
      const el = document.getElementById('toolResult');
      if (!el) return;
      
      el.style.display = 'block';
      el.innerHTML = '<div style="color:var(--warning)">æ‰§è¡Œä¸­...</div>';
      
      try {
        const task = await fetch(API + '/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: 'tool_' + toolName,
            requiredCapabilities: ['invoke_tool'],
            input: { action: 'tool', tool: toolName, args: {} }
          })
        });
        
        setTimeout(async () => {
          const tasks = await fetch(API + '/tasks').then(r => r.json());
          const t = tasks.find(x => x.name === 'tool_' + toolName);
          if (t && t.output && t.output.result) {
            el.innerHTML = JSON.stringify(t.output.result, null, 2);
          } else if (t && t.output && t.output.output) {
            el.innerHTML = t.output.output;
          } else {
            el.innerHTML = 'æ‰§è¡Œå®Œæˆ';
          }
        }, 3000);
      } catch (e) {
        el.innerHTML = 'æ‰§è¡Œå¤±è´¥: ' + e.message;
      }
    }

    function renderChatMessages() {
      const el = document.getElementById('chatMessages');
      if (!el) return;
      
      if (chatHistory.length === 0) {
        el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:40px">è¯·é€‰æ‹©æˆ–åˆ›å»ºä¼šè¯å¼€å§‹å¯¹è¯</div>';
        return;
      }
      
      el.innerHTML = chatHistory.map(m => 
        '<div style="margin-bottom:12px;padding:8px;border-radius:8px;background:' + (m.role === 'user' ? 'var(--accent)' : 'var(--bg2)') + '">' +
          '<div style="font-weight:600;font-size:12px;margin-bottom:4px">' + (m.role === 'user' ? 'ğŸ‘¤ ä½ ' : 'ğŸ¤– OpenClaw') + '</div>' +
          '<div>' + m.content + '</div>' +
        '</div>'
      ).join('');
      el.scrollTop = el.scrollHeight;
    }

    async function deleteSession(sessionId) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¼šè¯ï¼Ÿ')) return;
      
      try {
        await fetch(API + '/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: 'delete_session',
            requiredCapabilities: ['session_management'],
            input: { action: 'session_management', subaction: 'delete', session_id: sessionId }
          })
        });
        
        if (currentSessionId === sessionId) {
          currentSessionId = null;
          chatHistory = [];
          renderChatMessages();
        }
        
        loadOpenClawSessions();
      } catch (e) {
        alert('åˆ é™¤å¤±è´¥: ' + e.message);
      }
    }

    async function invokeTool(toolName, args) {
      const el = document.getElementById('toolResult');
      if (!el) return;
      
      el.style.display = 'block';
      el.innerHTML = '<div style="color:var(--warning)">æ‰§è¡Œä¸­...</div>';
      
      try {
        const task = await fetch(API + '/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: 'invoke_tool_' + toolName,
            requiredCapabilities: ['invoke_tool'],
            input: { action: 'tool', tool: toolName, args: args }
          })
        });
        
        setTimeout(async () => {
          const tasks = await fetch(API + '/tasks').then(r => r.json());
          const t = tasks.find(x => x.name === 'invoke_tool_' + toolName);
          if (t && t.output && t.output.result) {
            el.innerHTML = '<pre style="white-space:pre-wrap;margin:0">' + JSON.stringify(t.output.result, null,2) + '</pre>';
          } else if (t && t.output && t.output.error) {
            el.innerHTML = '<div style="color:var(--error)">é”™è¯¯: ' + t.output.error + '</div>';
          } else {
            el.innerHTML = '<div style="color:var(--muted)">æ‰§è¡Œå®Œæˆ</div>';
          }
        }, 3000);
      } catch (e) {
        el.innerHTML = '<div style="color:var(--error)">æ‰§è¡Œå¤±è´¥: ' + e.message + '</div>';
      }
    }

    let developerRepos = [];
    let developerAgents = [];
    let githubToken = localStorage.getItem('github_token') || '';
    
    async function renderDeveloperTab(c) {
      c.innerHTML = '<div class="section"><div class="section-header"><h2 class="section-title">ğŸ”§ å¼€å‘ä¸­å¿ƒ</h2></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">' +
          '<div style="background:var(--bg3);padding:16px;border-radius:8px">' +
            '<h3 style="margin:0 0 12px">ğŸ“¦ GitHub ä»“åº“</h3>' +
            '<input type="password" id="githubToken" placeholder="GitHub Token (å¯é€‰)" value="' + githubToken + '" style="width:100%;padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-bottom:8px">' +
            '<button class="btn btn-primary" onclick="loadGitHubRepos()" style="margin-right:8px">åŠ è½½ä»“åº“</button>' +
            '<button class="btn btn-secondary" onclick="saveGitHubToken()">ä¿å­˜Token</button>' +
            '<div id="repoList" style="margin-top:12px;max-height:200px;overflow:auto"></div>' +
          '</div>' +
          '<div style="background:var(--bg3);padding:16px;border-radius:8px">' +
            '<h3 style="margin:0 0 12px">ğŸ¤– OpenClaw æ™ºèƒ½ä½“</h3>' +
            '<button class="btn btn-primary" onclick="loadOpenClawAgents()">åˆ·æ–°æ™ºèƒ½ä½“åˆ—è¡¨</button>' +
            '<div id="ocAgentList" style="margin-top:12px;max-height:200px;overflow:auto"></div>' +
          '</div>' +
        '</div></div>' +
        '<div class="section">' +
          '<div class="section-header"><h3 class="section-title">ğŸš€ éƒ¨ç½²æ™ºèƒ½ä½“</h3></div>' +
          '<div style="background:var(--bg3);padding:16px;border-radius:8px">' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">' +
              '<div><label style="display:block;margin-bottom:4px;font-size:12px;color:var(--muted)">æ™ºèƒ½ä½“åç§°</label><input type="text" id="deployAgentName" placeholder="my-agent" style="width:100%;padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text)"></div>' +
              '<div><label style="display:block;margin-bottom:4px;font-size:12px;color:var(--muted)">GitHubä»“åº“è·¯å¾„</label><input type="text" id="deployRepoPath" placeholder="/root/.openclaw/workspace/github/xxx" style="width:100%;padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text)"></div>' +
            '</div>' +
            '<button class="btn btn-primary" onclick="deployToOpenClaw()">éƒ¨ç½²åˆ° OpenClaw</button>' +
            '<div id="deployResult" style="margin-top:12px;font-size:12px"></div>' +
          '</div>' +
        '</div>' +
        '<div class="section">' +
          '<div class="section-header"><h3 class="section-title">ğŸ“ ç¼–è¾‘æ™ºèƒ½ä½“</h3></div>' +
          '<div style="background:var(--bg3);padding:16px;border-radius:8px">' +
            '<select id="editAgentSelect" onchange="loadAgentForEdit()" style="padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-bottom:12px;width:200px">' +
              '<option value="">-- é€‰æ‹©æ™ºèƒ½ä½“ --</option>' +
            '</select>' +
            '<div id="agentEditor" style="display:none">' +
              '<div style="margin-bottom:12px"><label style="display:block;margin-bottom:4px;font-size:12px;color:var(--muted)">SOUL.md</label><textarea id="soulEditor" style="width:100%;height:150px;padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:monospace"></textarea></div>' +
              '<button class="btn btn-primary" onclick="saveAgentSOUL()">ä¿å­˜ SOUL.md</button>' +
              '<button class="btn btn-secondary" onclick="restartOpenClaw()" style="margin-left:8px">é‡å¯ OpenClaw</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      
      loadOpenClawAgents();
    }

    async function loadGitHubRepos() {
      const token = document.getElementById('githubToken').value;
      const repoList = document.getElementById('repoList');
      repoList.innerHTML = '<div style="color:var(--muted)">åŠ è½½ä¸­...</div>';
      
      try {
        const url = token ? API + '/developer/github/repos?token=' + encodeURIComponent(token) : API + '/developer/github/repos';
        const repos = await fetch(url).then(r => r.json());
        developerRepos = repos;
        repoList.innerHTML = repos.map(r => 
          '<div style="padding:8px;border-bottom:1px solid var(--border);cursor:pointer" onclick="cloneRepo(\'' + r.clone_url + '\')">' +
            '<div style="font-weight:500">' + r.name + '</div>' +
            '<div style="font-size:12px;color:var(--muted)">' + (r.description || 'æ— æè¿°') + '</div>' +
          '</div>'
        ).join('') || '<div style="color:var(--muted)">æœªæ‰¾åˆ°ä»“åº“</div>';
      } catch (e) {
        repoList.innerHTML = '<div style="color:var(--error)">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
      }
    }

    function saveGitHubToken() {
      const token = document.getElementById('githubToken').value;
      localStorage.setItem('github_token', token);
      alert('Tokenå·²ä¿å­˜');
    }

    async function cloneRepo(repoUrl) {
      if (!confirm('ç¡®å®šè¦å…‹éš†è¿™ä¸ªä»“åº“åˆ°OpenClawå·¥ä½œåŒºå—ï¼Ÿ')) return;
      
      const result = document.getElementById('deployResult');
      result.innerHTML = '<div style="color:var(--accent)">å…‹éš†ä¸­...</div>';
      
      try {
        const res = await fetch(API + '/developer/github/clone', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ repoUrl, token: document.getElementById('githubToken').value })
        });
        const data = await res.json();
        if (data.success) {
          result.innerHTML = '<div style="color:green">å…‹éš†æˆåŠŸ: ' + data.path + '</div>';
          document.getElementById('deployRepoPath').value = data.path;
        } else {
          result.innerHTML = '<div style="color:var(--error)">å…‹éš†å¤±è´¥: ' + data.error + '</div>';
        }
      } catch (e) {
        result.innerHTML = '<div style="color:var(--error)">å…‹éš†å¤±è´¥: ' + e.message + '</div>';
      }
    }

    async function loadOpenClawAgents() {
      const ocAgentList = document.getElementById('ocAgentList');
      if (!ocAgentList) return;
      
      ocAgentList.innerHTML = '<div style="color:var(--muted)">åŠ è½½ä¸­...</div>';
      
      try {
        const agents = await fetch(API + '/developer/openclaw/agents').then(r => r.json());
        developerAgents = agents;
        ocAgentList.innerHTML = agents.map(a => 
          '<div style="padding:8px;border-bottom:1px solid var(--border);cursor:pointer" onclick="selectDeveloperAgent(\'' + a.name + '\')">' +
            '<div style="font-weight:500">' + a.name + '</div>' +
            '<div style="font-size:12px;color:var(--muted)">SOUL: ' + (a.hasSOUL ? 'âœ“' : 'âœ—') + '</div>' +
          '</div>'
        ).join('') || '<div style="color:var(--muted)">æš‚æ— æ™ºèƒ½ä½“</div>';
        
        const select = document.getElementById('editAgentSelect');
        if (select) {
          select.innerHTML = '<option value="">-- é€‰æ‹©æ™ºèƒ½ä½“ --</option>' + 
            agents.map(a => '<option value="' + a.name + '">' + a.name + '</option>').join('');
        }
      } catch (e) {
        ocAgentList.innerHTML = '<div style="color:var(--error)">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
      }
    }

    async function deployToOpenClaw() {
      const agentName = document.getElementById('deployAgentName').value;
      const sourcePath = document.getElementById('deployRepoPath').value;
      const result = document.getElementById('deployResult');
      
      if (!agentName) {
        result.innerHTML = '<div style="color:var(--error)">è¯·è¾“å…¥æ™ºèƒ½ä½“åç§°</div>';
        return;
      }
      
      result.innerHTML = '<div style="color:var(--accent)">éƒ¨ç½²ä¸­...</div>';
      
      try {
        const res = await fetch(API + '/developer/openclaw/deploy', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ agentName, sourcePath })
        });
        const data = await res.json();
        if (data.success) {
          result.innerHTML = '<div style="color:green">éƒ¨ç½²æˆåŠŸ: ' + data.message + '</div>';
          loadOpenClawAgents();
        } else {
          result.innerHTML = '<div style="color:var(--error)">éƒ¨ç½²å¤±è´¥: ' + data.error + '</div>';
        }
      } catch (e) {
        result.innerHTML = '<div style="color:var(--error)">éƒ¨ç½²å¤±è´¥: ' + e.message + '</div>';
      }
    }

    async function loadAgentForEdit() {
      const agentName = document.getElementById('editAgentSelect').value;
      const editor = document.getElementById('agentEditor');
      
      if (!agentName) {
        editor.style.display = 'none';
        return;
      }
      
      try {
        const agent = await fetch(API + '/developer/openclaw/agent/' + agentName).then(r => r.json());
        document.getElementById('soulEditor').value = agent.soul || '';
        editor.style.display = 'block';
      } catch (e) {
        alert('åŠ è½½å¤±è´¥: ' + e.message);
      }
    }

    async function saveAgentSOUL() {
      const agentName = document.getElementById('editAgentSelect').value;
      const soul = document.getElementById('soulEditor').value;
      
      if (!agentName) {
        alert('è¯·é€‰æ‹©æ™ºèƒ½ä½“');
        return;
      }
      
      try {
        const res = await fetch(API + '/developer/openclaw/agent/' + agentName, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ soul })
        });
        const data = await res.json();
        if (data.success) {
          alert('ä¿å­˜æˆåŠŸ');
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + data.error);
        }
      } catch (e) {
        alert('ä¿å­˜å¤±è´¥: ' + e.message);
      }
    }

    async function restartOpenClaw() {
      if (!confirm('ç¡®å®šè¦é‡å¯OpenClawæœåŠ¡å—ï¼Ÿ')) return;
      
      try {
        const res = await fetch(API + '/developer/openclaw/restart', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          alert('OpenClawæ­£åœ¨é‡å¯ï¼Œè¯·ç¨å€™åˆ·æ–°é¡µé¢');
        } else {
          alert('é‡å¯å¤±è´¥: ' + data.error);
        }
      } catch (e) {
        alert('é‡å¯å¤±è´¥: ' + e.message);
      }
    }

    document.getElementById('nav-openclaw-ext')?.addEventListener('click', function() {
      var url = this.getAttribute('data-url');
      if (url) window.open(url, '_blank');
    });

    fetchData();
    setInterval(fetchData, 5000);
  </script>
</body>
</html>
